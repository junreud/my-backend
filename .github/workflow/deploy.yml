name: Deploy to Mac Server - Backend

on:
  push:
    branches:
      - main

jobs:
  deploy-job:
    runs-on: self-hosted  # 로컬 맥북 Runner (self-hosted)에서 실행
    steps:
      # 1) 저장소 체크아웃
      - name: Check out repository
        uses: actions/checkout@v3

      # 2) Node 버전 지정 (선택)
      - name: Use Node.js 23.7
        uses: actions/setup-node@v3
        with:
          node-version: 23.7

      # 3) .env 파일 생성 (Secrets에 저장된 PRODUCTION_ENV 내용 사용)
      - name: Create .env file
        run: |
          echo "${{ secrets.PRODUCTION_ENV }}" > .env

      # [추가] 4) Homebrew로 MySQL 설치 (이미 되어 있다면 스킵 가능)
      - name: Install MySQL (Homebrew)
        run: |
          brew update
          brew install mysql || true

      # [추가] 5) MySQL 서비스 시작
      # launchctl, brew services 권한 이슈가 없다고 가정. 혹은 mysql.server start 사용 가능
      - name: Start MySQL
        run: |
          brew services start mysql || true
          # 또는:
          # mysql.server start

      # 6) 설치 & 빌드 (Express, TS 등)
      - name: Install & Build Backend
        run: |
          npm install
          # 만약 TypeScript라면 npm run build (tsc) 등
          # npm run build

      # 7) PM2로 서버 재시작
      - name: Restart Backend Server
        run: |
          pm2 stop app || true
          pm2 start app.js
          # 혹은: pm2 start 'npm run start'

